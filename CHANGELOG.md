# 功能改进说明 (2025-12-27)

## 本次更新内容

根据用户反馈的问题，进行了以下 4 项改进：

### 1. ✅ 增加详细日志记录

#### 配置变更
- **文件**: `application.yml`
- **改进**:
  - 日志输出到文件: `logs/bilibili-music.log`
  - 滚动策略: 单个文件最大 10MB，保留 7 天历史
  - 分别配置控制台和文件输出格式

#### 日志内容
现在可以查看：
- ✅ AI 的理解过程（关键词提取的理由）
- ✅ 获取到的所有视频信息
- ✅ 筛选过程和理由
- ✅ 每个阶段的详细输出

#### 查看日志
```bash
# 实时查看日志
Get-Content logs/bilibili-music.log -Wait

# 查看最新 100 行
Get-Content logs/bilibili-music.log -Tail 100
```

#### 日志示例
```
============================================================
[PlaylistAgent] 开始执行任务
[PlaylistAgent] 用户输入：帮我找夜鹿的歌
============================================================
[Stage 1/4] 关键词提取
[KeywordExtractionSkill] 原始查询: 帮我找夜鹿的歌
[KeywordExtractionSkill] LLM 理解: 用户想搜索歌手夜鹿的音乐作品
[Stage 1/4] 提取的关键词：夜鹿
[Stage 2/4] 视频检索
  - 夜鹿《星辰大海》 | 夜鹿Official | 03:45
  - 夜鹿《时光代理人》 | 夜鹿Official | 04:12
[Stage 3/4] 视频筛选
[Stage 3/4] 筛选理由：这些都是夜鹿的官方音乐作品
  ✅ 夜鹿《星辰大海》 | 夜鹿Official | 03:45
```

---

### 2. ✅ 智能关键词提取

#### 新增组件
- **文件**: `KeywordExtractionSkill.java`
- **功能**: 使用 LLM 从用户自然语言中提取核心搜索关键词

#### 解决问题
**之前**: 
- 用户输入 "帮我找夜鹿的歌" → 直接搜索整句话 ❌
- 结果不相关

**现在**:
- 用户输入 "帮我找夜鹿的歌" → AI 提取 "夜鹿" ✅
- 搜索更精准

#### 示例
| 用户输入 | 提取的关键词 |
|---------|------------|
| 帮我找夜鹿的歌 | 夜鹿 |
| 来一份适合学习的纯音乐 | 纯音乐 学习 |
| 搜索周杰伦的歌曲 | 周杰伦 |

#### 流程
```
用户输入 → KeywordExtractionSkill → 提取关键词 → BilibiliSearchService
           (LLM 理解)
```

---

### 3. ✅ 播放器自动播放优化

#### 修改内容
- **文件**: `index.html`
- **改进**:
  - 添加 `muted=0` 参数，默认不静音
  - 添加 `allow="autoplay"` 属性，允许自动播放
  - 浏览器允许时，点击视频后自动播放并有声音

#### 修改前
```html
<iframe src="...?bvid=${bvid}&autoplay=1">
```

#### 修改后
```html
<iframe 
  src="...?bvid=${bvid}&autoplay=1&muted=0"
  allow="autoplay">
```

⚠️ **注意**: 由于浏览器安全策略，某些情况下仍需手动点击播放按钮

---

### 4. ✅ 基于标签的相关性判断

#### 数据模型扩展
- **文件**: `VideoInfo.java`
- **新增字段**:
  ```java
  private String tags;         // 视频标签
  private String description;  // 视频描述
  ```

#### 筛选逻辑增强
- **文件**: `CurationSkill.java`
- **改进**:
  - Prompt 中包含标签信息
  - AI 筛选时考虑标签相关性
  - 明确指示过滤不相关视频

#### 新的筛选规则
LLM 现在会重点关注：
1. ✅ 视频标题是否包含用户搜索的关键词
2. ✅ 标签是否与用户需求相关（如果有标签）
3. ✅ 作者是否是用户要找的人
4. ✅ 过滤掉明显不相关的视频（比如其他人的翻唱、其他类型的视频）

#### 示例 Prompt
```
搜索到的视频列表：
[0] 标题: 夜鹿《星辰大海》 | 作者: 夜鹿Official | 时长: 03:45 | 标签: 原创音乐,流行
[1] 标题: 【翻唱】星辰大海 | 作者: 其他UP主 | 时长: 03:50 | 标签: 翻唱,Cover

筛选时请重点关注：
1. 视频标题是否包含用户搜索的关键词
2. 标签是否与用户需求相关（如果有标签）
3. 作者是否是用户要找的人
4. 过滤掉明显不相关的视频
```

⚠️ **当前限制**: B 站搜索页面的标签需要点击进入详情页才能获取，暂时标签字段为空。后续可以考虑：
- 方案 A：点击进入每个视频详情页抓取标签（会变慢）
- 方案 B：使用 B 站 API（需要 Cookie 认证）

---

## 执行流程对比

### 之前 (3 阶段)
```
用户输入 → 搜索视频 → 筛选视频 → 生成总结
```

### 现在 (4 阶段)
```
用户输入 → 提取关键词 → 搜索视频 → 筛选视频 → 生成总结
          💬 理解需求   🔍 检索     🎵 筛选     📝 总结
```

---

## 使用建议

### 1. 查看详细日志
```bash
# Windows PowerShell
Get-Content logs/bilibili-music.log -Wait -Tail 50
```

### 2. 测试关键词提取
试试这些输入：
- ✅ "帮我找夜鹿的歌"
- ✅ "来一份适合工作的轻音乐"
- ✅ "搜索周杰伦最近的新歌"

### 3. 观察 AI 理解过程
日志中会显示：
- AI 提取的关键词
- AI 理解用户意图的原因
- AI 筛选视频的理由

---

## 技术细节

### 新增依赖
无新增依赖

### 新增文件
1. `KeywordExtractionSkill.java` - 关键词提取能力
2. `logs/bilibili-music.log` - 日志文件（自动生成）

### 修改文件
1. `VideoInfo.java` - 添加标签和描述字段
2. `PlaylistAgent.java` - 添加关键词提取阶段，增强日志
3. `CurationSkill.java` - 优化筛选 Prompt，包含标签信息
4. `BilibiliSearchService.java` - 适配新的数据模型
5. `application.yml` - 配置日志输出
6. `index.html` - 优化播放器参数

---

## 已知问题

1. **标签获取**: 当前标签字段为空，因为 B 站搜索页面不直接展示标签
2. **浏览器限制**: 自动播放可能受浏览器策略限制，部分情况需手动点击
3. **LLM 性能**: 关键词提取会增加约 1-3 秒的处理时间

---

## 后续优化方向

1. 🔧 **标签抓取**: 点击进入视频详情页获取完整标签
2. 🔧 **缓存机制**: 缓存已搜索的视频信息，避免重复搜索
3. 🔧 **多模型支持**: 支持切换不同的 Ollama 模型
4. 🔧 **个性化记忆**: 记住用户偏好，优化推荐

---

**更新时间**: 2025-12-27  
**版本**: v0.2.0
